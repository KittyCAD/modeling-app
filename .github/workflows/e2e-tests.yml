name: E2E Tests
on:
  push:
    branches: [ main, pierremtb/adhoc/e2e-no-cache-no-shard ]
  pull_request:

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

permissions:
  contents: write
  pull-requests: write
  actions: read


jobs:
  electron:
    timeout-minutes: 60
    name: playwright:electron:${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [namespace-profile-ubuntu-8-cores, namespace-profile-macos-8-cores, windows-16-cores]
    runs-on: ${{ matrix.os }}
    steps:
    - uses: actions/create-github-app-token@v1
      id: app-token
      with:
        app-id: ${{ secrets.MODELING_APP_GH_APP_ID }}
        private-key: ${{ secrets.MODELING_APP_GH_APP_PRIVATE_KEY }}
        owner: ${{ github.repository_owner }}

    - uses: actions/checkout@v4
      with:
        token: ${{ steps.app-token.outputs.token }}

    - uses: actions/setup-node@v4
      with:
        node-version-file: '.nvmrc'

    - name: Install dependencies
      run: yarn

    - name: Install Playwright Browsers
      run: yarn playwright install --with-deps

    - name: Build Wasm
      shell: bash
      run: yarn build:wasm

    - name: build web
      run: yarn tronb:vite:dev

    - name: Run playwright/electron flow on ubuntu (with retries)
      if: contains(matrix.os, 'ubuntu')
      run: |
        xvfb-run --auto-servernum --server-args="-screen 0 1280x960x24" -- yarn test:playwright:electron:ubuntu --retries 20
      env:
        CI: true
        FAIL_ON_CONSOLE_ERRORS: true
        NODE_ENV: development
        VITE_KC_DEV_TOKEN: ${{ secrets.KITTYCAD_API_TOKEN_DEV }}
        VITE_KC_SKIP_AUTH: true
        token: ${{ secrets.KITTYCAD_API_TOKEN_DEV }}

    - name: Run playwright/electron flow on windows (with retries)
      if: contains(matrix.os, 'windows')
      id: retry
      run: |
        yarn test:playwright:electron:windows --retries 20
      env:
        CI: true
        FAIL_ON_CONSOLE_ERRORS: true
        NODE_ENV: development
        VITE_KC_DEV_TOKEN: ${{ secrets.KITTYCAD_API_TOKEN_DEV }}
        VITE_KC_SKIP_AUTH: true
        token: ${{ secrets.KITTYCAD_API_TOKEN_DEV }}

    - name: Run playwright/electron flow on macos (with retries)
      if: contains(matrix.os, 'macos')
      run: |
        yarn test:playwright:electron:macos --retries 20
      env:
        CI: true
        FAIL_ON_CONSOLE_ERRORS: true
        NODE_ENV: development
        VITE_KC_DEV_TOKEN: ${{ secrets.KITTYCAD_API_TOKEN_DEV }}
        VITE_KC_SKIP_AUTH: true
        token: ${{ secrets.KITTYCAD_API_TOKEN_DEV }}
